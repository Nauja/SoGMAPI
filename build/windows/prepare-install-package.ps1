#
#
# This is the PowerShell equivalent of ../unix/prepare-install-package.sh, *except* that it doesn't
# set Linux permissions, create the install.dat files, or create the final zip (unless you specify
# --windows-only). Due to limitations in PowerShell, the final changes are handled by the
# windows/finalize-install-package.sh file in WSL.
#
# When making changes, make sure to update ../unix/prepare-install-package.ps1 too.
#
#

. "$PSScriptRoot/lib/in-place-regex.ps1"


##########
## Fetch values
##########
# paths
$gamePath = "C:\Program Files (x86)\Steam\steamapps\common\SecretsOfGrindea"
$bundleModNames = "ConsoleCommands", "ErrorHandler", "SaveBackup"

# build configuration
$buildConfig = "Release"
$folders = "linux", "macOS", "windows"
$runtimes = @{ linux = "linux-x86"; macOS = "osx-x86"; windows = "win-x86" }
$msBuildPlatformNames = @{ linux = "Unix"; macOS = "OSX"; windows = "Windows_NT" }

# version number
$version = $args[0]
if (!$version) {
    $version = Read-Host "SoGMAPI release version (like '4.0.0')"
}

# Windows-only build
$windowsOnly = $false
foreach ($arg in $args) {
    if ($arg -eq "--windows-only") {
        $windowsOnly = $true
        $folders = "windows"
        $runtimes = @{ windows = "win-x86" }
        $msBuildPlatformNames = @{ windows = "Windows_NT" }
    }
}


##########
## Move to SoGMAPI root
##########
cd "$PSScriptRoot/../.."


##########
## Clear old build files
##########
echo "Clearing old builds..."
echo "-------------------------------------------------"

foreach ($path in (dir -Recurse -Include ('bin', 'obj'))) {
    echo "$path"
    rm -Recurse -Force "$path"
}
echo ""


##########
## Compile files
##########
. "$PSScriptRoot/set-sogmapi-version.ps1" "$version"
foreach ($folder in $folders) {
    $runtime = $runtimes[$folder]
    $msbuildPlatformName = $msBuildPlatformNames[$folder]

    echo "Compiling SoGMAPI for $folder..."
    echo "-------------------------------------------------"
    dotnet publish src/SoGMAPI --configuration $buildConfig -v minimal --runtime "$runtime" -p:OS="$msbuildPlatformName" -p:GamePath="$gamePath" -p:CopyToGameFolder="false" --self-contained true
    echo ""
    echo ""

    echo "Compiling installer for $folder..."
    echo "-------------------------------------------------"
    dotnet publish src/SoGMAPI.Installer --configuration $buildConfig -v minimal --runtime "$runtime" -p:OS="$msbuildPlatformName" -p:GamePath="$gamePath" -p:CopyToGameFolder="false" -p:PublishTrimmed=True -p:TrimMode=Link --self-contained true
    echo ""
    echo ""

    foreach ($modName in $bundleModNames) {
        echo "Compiling $modName for $folder..."
        echo "-------------------------------------------------"
        dotnet publish src/SoGMAPI.Mods.$modName --configuration $buildConfig -v minimal --runtime "$runtime" -p:OS="$msbuildPlatformName" -p:GamePath="$gamePath" -p:CopyToGameFolder="false"
        echo ""
        echo ""
    }
}


##########
## Prepare install package
##########
echo "Preparing install package..."
echo "----------------------------"

# init paths
$installAssets = "src/SoGMAPI.Installer/assets"
$packagePath = "bin/SoGMAPI installer"
$packageDevPath = "bin/SoGMAPI installer for developers"

# init structure
foreach ($folder in $folders) {
    mkdir "$packagePath/internal/$folder/bundle/sogmapi-internal" > $null
}

# copy base installer files
foreach ($name in @("install on Linux.sh", "install on macOS.command", "install on Windows.bat", "README.txt")) {
    if ($windowsOnly -and ($name -eq "install on Linux.sh" -or $name -eq "install on macOS.command")) {
        continue;
    }

    cp "$installAssets/$name" "$packagePath"
}

# copy per-platform files
foreach ($folder in $folders) {
    $runtime = $runtimes[$folder]

    # get paths
    $sogmapiBin = "src/SoGMAPI/bin/$buildConfig/$runtime/publish"
    $internalPath = "$packagePath/internal/$folder"
    $bundlePath = "$internalPath/bundle"

    # installer files
    cp "src/SoGMAPI.Installer/bin/$buildConfig/$runtime/publish/*" "$internalPath" -Recurse
    rm -Recurse -Force "$internalPath/assets"

    # runtime config for SoGMAPI
    # This is identical to the one generated by the build, except that the min runtime version is
    # set to 5.0.0 (instead of whatever version it was built with) and rollForward is set to latestMinor instead of
    # minor.
    cp "$installAssets/runtimeconfig.json" "$bundlePath/SoGModdingAPI.runtimeconfig.json"

    # installer DLL config
    if ($folder -eq "windows") {
        cp "$installAssets/windows-exe-config.xml" "$packagePath/internal/windows/install.exe.config"
    }

    # bundle root files
    foreach ($name in @("SoGModdingAPI", "SoGModdingAPI.dll", "SoGModdingAPI.pdb", "SoGModdingAPI.xml", "steam_appid.txt")) {
        if ($name -eq "SoGModdingAPI" -and $folder -eq "windows") {
            $name = "$name.exe"
        }

        cp "$sogmapiBin/$name" "$bundlePath"
    }

    # bundle i18n
    cp -Recurse "$sogmapiBin/i18n" "$bundlePath/sogmapi-internal"

    # bundle sogmapi-internal
    foreach ($name in @("0Harmony.dll", "0Harmony.xml", "Mono.Cecil.dll", "Mono.Cecil.Mdb.dll", "Mono.Cecil.Pdb.dll", "MonoMod.Common.dll", "Newtonsoft.Json.dll", "Pathoschild.Http.Client.dll", "Pintail.dll", "TMXTile.dll", "SoGMAPI.Toolkit.dll", "SoGMAPI.Toolkit.pdb", "SoGMAPI.Toolkit.xml", "SoGMAPI.Toolkit.CoreInterfaces.dll", "SoGMAPI.Toolkit.CoreInterfaces.pdb", "SoGMAPI.Toolkit.CoreInterfaces.xml", "System.Net.Http.Formatting.dll")) {
        cp "$sogmapiBin/$name" "$bundlePath/sogmapi-internal"
    }

    if ($folder -eq "windows") {
        cp "$sogmapiBin/VdfConverter.dll" "$bundlePath/sogmapi-internal"
    }

    cp "$sogmapiBin/SoGMAPI.config.json" "$bundlePath/sogmapi-internal/config.json"
    cp "$sogmapiBin/SoGMAPI.metadata.json" "$bundlePath/sogmapi-internal/metadata.json"
    if ($folder -eq "linux" -or $folder -eq "macOS") {
        cp "$installAssets/unix-launcher.sh" "$bundlePath"
    }
    else {
        cp "$installAssets/windows-exe-config.xml" "$bundlePath/SoGModdingAPI.exe.config"
    }

    # copy .NET dependencies
    if ($folder -eq "windows") {
        cp "$sogmapiBin/System.Management.dll" "$bundlePath/sogmapi-internal"
    }

    # copy legacy .NET dependencies (remove in SoGMAPI 4.0.0)
    cp "$sogmapiBin/System.Configuration.ConfigurationManager.dll" "$bundlePath/sogmapi-internal"
    cp "$sogmapiBin/System.Runtime.Caching.dll" "$bundlePath/sogmapi-internal"
    cp "$sogmapiBin/System.Security.Permissions.dll" "$bundlePath/sogmapi-internal"

    # copy bundled mods
    foreach ($modName in $bundleModNames) {
        $fromPath = "src/SoGMAPI.Mods.$modName/bin/$buildConfig/$runtime/publish"
        $targetPath = "$bundlePath/Mods/$modName"

        mkdir "$targetPath" > $null

        cp "$fromPath/$modName.dll" "$targetPath"
        cp "$fromPath/$modName.pdb" "$targetPath"
        cp "$fromPath/manifest.json" "$targetPath"
        if (Test-Path "$fromPath/i18n" -PathType Container) {
            cp -Recurse "$fromPath/i18n" "$targetPath"
        }
    }
}

# DISABLED: will be handled by Linux script
# mark scripts executable
#ForEach ($path in @("install on Linux.sh", "install on macOS.command", "bundle/unix-launcher.sh")) {
#    if (Test-Path "$packagePath/$path" -PathType Leaf) {
#        chmod 755 "$packagePath/$path"
#    }
#}

# split into main + for-dev folders
cp -Recurse "$packagePath" "$packageDevPath"
foreach ($folder in $folders) {
    # disable developer mode in main package
    In-Place-Regex -Path "$packagePath/internal/$folder/bundle/sogmapi-internal/config.json" -Search "`"DeveloperMode`": true" -Replace "`"DeveloperMode`": false"

    # convert bundle folder into final 'install.dat' files
    if ($windowsOnly)
    {
        foreach ($path in @("$packagePath/internal/$folder", "$packageDevPath/internal/$folder"))
        {
            Compress-Archive -Path "$path/bundle/*" -CompressionLevel Optimal -DestinationPath "$path/install.zip"
            mv "$path/install.zip" "$path/install.dat"
            rm -Recurse -Force "$path/bundle"
        }
    }
}


###########
### Create release zips
###########
# rename folders
mv "$packagePath" "bin/SoGMAPI $version installer"
mv "$packageDevPath" "bin/SoGMAPI $version installer for developers"

# package files
if ($windowsOnly)
{
    Compress-Archive -Path "bin/SoGMAPI $version installer" -DestinationPath "bin/SoGMAPI $version installer.zip" -CompressionLevel Optimal
    Compress-Archive -Path "bin/SoGMAPI $version installer for developers" -DestinationPath "bin/SoGMAPI $version installer for developers.zip" -CompressionLevel Optimal
}

echo ""
echo "Done! See docs/technical/smapi.md to create the release zips."
